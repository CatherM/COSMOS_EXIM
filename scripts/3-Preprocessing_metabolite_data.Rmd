---
title: "3 - Preprocessing Metabolomics"
author: "Cathy Magnée, Saezlab"
date: "2024-06-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Preprocessing metabolomics data 

This document describes the preprocessing of metabolomic T cell data. It is based off the preprocessing documents in the FACTOR_Cosmos No_MOFA branch by Saezlab on github. This document is preceded by the 2 - Preprocessing transcriptomic data R markdown document and precedes the 4 - Preparing COSMOS inputs R markdown document. 

This document is annotated to explain the steps and the choices that were made durnig this project. Other options will be highlighted. 

Document summary:
The main goal of this document is to transform the raw metabolite data into data that can be compared across sample. This will be done in the following steps and using the following tools:
1. Two steps of filtering (outliers)
2. Normalization using vsn normalization
3. Scaling using Z-score normalization.

#### Loading

Libraries
```{r, echo=FALSE, warning=FALSE}
library(readr)
library(reshape2)
library(pheatmap)
library(vsn)
library(tibble)
```

Data paths:
Splitting these in AMC and Laptop, so it is easier to switch. 

AMC:
```{r}
# T0_path <- "L:\\basic\\divg\\EXIM\\ImmunoHematology\\Cathy Magnée\\Data\\CD3_HDvsCLL\\Metabolomic\\T0_metabs_raw.csv"
# T48_path <- "L:\\basic\\divg\\EXIM\\ImmunoHematology\\Cathy Magnée\\Data\\CD3_HDvsCLL\\Metabolomic\\T48_metabs_raw.csv"

# or hmdb?
T0_path <- "L:\\basic\\divg\\EXIM\\ImmunoHematology\\Cathy Magnée\\Data\\CD3_HDvsCLL\\Metabolomic\\T0_metabs_hmdb.csv"
T48_path <- "L:\\basic\\divg\\EXIM\\ImmunoHematology\\Cathy Magnée\\Data\\CD3_HDvsCLL\\Metabolomic\\T48_metabs_hmdb.csv"

```
Laptop:
```{r}
# T0_path <- "../ourdata/metabolomic/T0_metabs_raw.csv"
# T48_path <- "../ourdata/metabolomic/T48_metabs_raw.csv"

# or hmdb?
# T0_path <- "../ourdata/metabolomic/T0_metabs_hmdb.csv"
# T48_path <- "../ourdata/metabolomic/T48_metabs_hmdb.csv"
```

Loading data and removing paths:
```{r}
# T0_metabs_raw <- as.data.frame(read_csv(T0_path))
# T48_metabs_raw <- as.data.frame(read_csv(T48_path))

# or hmdb?
T0_metabs_hmdb <- as.data.frame(read_csv(T0_path))
T48_metabs_hmdb <- as.data.frame(read_csv(T48_path))

# Adjusting first column to rownames
T0_metabs_hmdb <- tibble::column_to_rownames(T0_metabs_hmdb, var = "...1")
T48_metabs_hmdb <- tibble::column_to_rownames(T48_metabs_hmdb, var = "...1")

# Removing redundant paths
rm(T0_path)
rm(T48_path)

```

### Plotting and filtering

Plotting the data to see the distribution is the first step to understanding our data

```{r}
hist(as.numeric(unlist(log2(T0_metabs_hmdb))), breaks = 500)
hist(as.numeric(unlist(log2(T48_metabs_hmdb))), breaks = 500)

```

Heatmaps:
```{r}
pheatmap(log2(T0_metabs_hmdb), show_colnames = F, show_rownames = F) 

# pheatmap(abs(log2(T48_metabs_hmdb)), show_colnames = F, show_rownames = F)

```


In the T48 dataset the histogram of the log2 values are all negative. This means all values are between 0 and 1. This should be adjusted for later wehen we use VSN normalization

The T0 heatmap also does not show much interesting as there are low values skewing the heatmap.

For the log2(T0) dataset, there are a some outliers <-30
For log2(T48), The outliers are -Inf (these are 0's)

Removing outliers:
```{r}
T0_metabs_hmdb[log2(T0_metabs_hmdb) < -30] <- NA 
T48_metabs_hmdb[log2(T48_metabs_hmdb) == -Inf] <- NA 

```

```{r}
hist(as.numeric(unlist(log2(T0_metabs_hmdb))), breaks = 1000)
hist(as.numeric(unlist(log2(T48_metabs_hmdb))), breaks = 1000)

```
Heatmaps after outlier removal:
```{r}
pheatmap(log2(T0_metabs_hmdb), show_colnames = F, show_rownames = F) 

pheatmap(abs(log2(T48_metabs_hmdb)), show_colnames = F, show_rownames = F)
```

Removing new outliers
- For log2 T0: <-1 and> 11
- For log2 T48: <-16 and >-6

```{r}
T0_metabs_hmdb[log2(T0_metabs_hmdb) < -1] <- NA 
T0_metabs_hmdb[log2(T0_metabs_hmdb) > 11 ] <- NA 

T48_metabs_hmdb[log2(T48_metabs_hmdb) < -16] <- NA 
T48_metabs_hmdb[log2(T48_metabs_hmdb) > 6] <- NA 
```


The histogram values of (log) T48 are only negative. This means the m/z ratios are all between 0-1. 

VSN normalization is used to adjust values to be able to compare across samples

### VSN normalization
First for T0
```{r}
T0_metabs_hmdb <- T0_metabs_hmdb[,-4]
fit <- vsnMatrix(as.matrix(T0_metabs_hmdb))
meanSdPlot(fit)
T0_metabs_hmdb <- as.data.frame(vsn::predict(fit,as.matrix(T0_metabs_hmdb)))

```
Note that in the above chunk, CLL2474 is removed from the dataset as it proved to be an outlier in the downstream analysis. I do not want this to influence the vsnMatrix normalization. 

Then for T48:
```{r}
fit <- vsnMatrix(as.matrix(T48_metabs_hmdb))
meanSdPlot(fit)
T48_metabs_hmdb <- as.data.frame(vsn::predict(fit,as.matrix(T48_metabs_hmdb)))
```

```{r}
pheatmap(T0_metabs_hmdb[complete.cases(T0_metabs_hmdb),], show_colnames = T, show_rownames = F, cluster_rows = F) # , color = colorRampPalette(c("lightgrey","cornflowerblue", "blue"))(100)

pheatmap(T48_metabs_hmdb[complete.cases(T48_metabs_hmdb),], show_colnames = T, show_rownames = F, cluster_rows = F) # , color = colorRampPalette(c("forestgreen","lightgrey", "blue"))(100))  
```

### Scaling using Z-normalization
T0:
```{r}

SDs <- apply(T0_metabs_hmdb,1,function(x){sd(x,na.rm = T)})
means <- rowMeans(T0_metabs_hmdb, na.rm = T)
T0_metabs_scaled <- (T0_metabs_hmdb - means) / SDs
pheatmap(T0_metabs_scaled[complete.cases(T0_metabs_scaled),], show_colnames = T, show_rownames = F, cluster_rows = F) 

hist(as.numeric(unlist(T0_metabs_scaled)), breaks = 1000) 
```

CLL2474 is an outlier. For now, this one is taken out (this has been done previously)

T48:
```{r}
SDs <- apply(T48_metabs_hmdb,1,function(x){sd(x,na.rm = T)})
means <- rowMeans(T48_metabs_hmdb, na.rm = T)
T48_metabs_scaled <- (T48_metabs_hmdb - means) / SDs
pheatmap(T48_metabs_scaled[complete.cases(T48_metabs_scaled),], show_colnames = T, show_rownames = F, cluster_rows = F) 

hist(as.numeric(unlist(T48_metabs_scaled)), breaks = 1000) 
```


### Save data
AMC
```{r}
############ Paths to write data to AMC PC ############ 
write.csv(T0_metabs_scaled,file = "L:\\basic\\divg\\EXIM\\ImmunoHematology\\Cathy Magnée\\Data\\CD3_HDvsCLL\\Metabolomic\\T0_metabs_hmdb_scaled.csv")
write.csv(T48_metabs_scaled,file = "L:\\basic\\divg\\EXIM\\ImmunoHematology\\Cathy Magnée\\Data\\CD3_HDvsCLL\\Metabolomic\\T48_metabs_hmdb_scaled.csv")
```

Laptop
```{r}
############ Paths to write data to laptop ############ 
# write.csv(T0_metabs_scaled,file = "../ourdata/metabolomic/T0_metabs_hmdb_scaled.csv")
# write.csv(T48_metabs_scaled,file = "../ourdata/metabolomic/T48_metabs_hmdb_scaled.csv")
```


---
title: "4-Run_CosmosR"
author: "Cathy Magn√©e, Saezlab"
date: "2024-05-08"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Run COSMOS

This document is the annotated version of the run_cosmos.R script that
can be found on Saezlab's Factor_COSMOS github main branch, in the
subfolder scripts, here:
<https://github.com/saezlab/Factor_COSMOS/blob/main/scripts/run_cosmos.R>

### Installing packages, loading libraries, loading data

If you do not have them yet, please properly install CARNIVAL and COSMOS
from Github:

```{r}
# remotes::install_github("saezlab/cosmosR")
# install.packages("devtools")
# devtools::install_github("saezlab/CARNIVAL")
```

Libraries:

```{r}
library(cosmosR)
library(readr)
library(dplyr)
library(CARNIVAL)
```

Loading data: Select which cell line (for us, which patient??) you wish
to analyze

```{r}
# source("Factor_COSMOS/scripts/decoupleRnival.R")

# data("meta_network")
load("meta_network.RData")

meta_network <- meta_network_cleanup(meta_network)

# load("Factor_COSMOS/data/cosmos/cosmos_inputs.RData")
load("data/cosmos/native/cosmos_inputs.RData")

```

metanetwork.RData can be found here <https://github.com/saezlab/Factor_COSMOS/blob/MOFA_COSMOS_pipeline/support/meta_network.RData>


### Selecting cell line to analyze

```{r, echo=FALSE}
# Check below for available cell line names
names(cosmos_inputs)

cell_line <- "786-0" #"RPMI-8226" # Select cell line you want to analyze with cosmos HERE


sig_input <- cosmos_inputs[[cell_line]]$TF_scores
metab_input <- cosmos_inputs[[cell_line]]$metabolomic
RNA_input <- cosmos_inputs[[cell_line]]$RNA
```

### Parameters

Choose which compartment to assign to the metabolic measurements:
Possible values are "r", "c", "e", "x", "m", "l", "n" and "g". More info
here <http://bigg.ucsd.edu/compartments> "r", endoplasmic reticulum "c",
cytosol "e", extracellular space "x", peroxisome / glyoxysome "m",
mitochondria "l", lysosome "n", nucleus "g", golgi apparatus

```{r}
#Choose which compartment to assign to the metabolic measurements
metab_input <- prepare_metab_inputs(metab_input, c("c","m"))

##Filter significant inputs
sig_input <- sig_input[abs(sig_input) > 2]
metab_input <- metab_input[abs(metab_input) > 2]

```

## IBM Cplex Options

```{r}
#In order to adapt options to users specification we can load them into a variable 
#that will then be passed to preprocess_COSMOS_signaling_to_metabolism CARNIVAL_options parameter
my_options <- default_CARNIVAL_options(solver = "cplex")

#Here the user should provide a path to its CPLEX executable (only cplex at the moment, other solvers will be documented soon !)
# my_options$solverPath <- "~/Documents/cplex" #or cbc solver executable
my_options$solverPath <- "C:/Program Files/IBM/ILOG/CPLEX_Studio2211/cplex/bin/x64_win64"
my_options$workdir <- file.path(getwd(), "cplex")
my_options$outputFolder <- file.path(getwd(), "cplex")
# my_options$solverPath <- "cbc/cbc-osx/cbc" #or cbc solver executable
my_options$solver <- "cplex" #or cbc
# my_options$solver <- "cbc"
my_options$timelimit <- 3600/10
my_options$mipGAP <- 0.05
my_options$threads <- 6
```

Note: You need IBM Cplex for this, your location may be different from
mine.

## Preprocessing signalling to metab

```{r}
metab_input <- cosmosR:::filter_input_nodes_not_in_pkn(metab_input, meta_network)
sig_input <- cosmosR:::filter_input_nodes_not_in_pkn(sig_input, meta_network)

test_for <- preprocess_COSMOS_signaling_to_metabolism(meta_network = meta_network[,c(1,3,2)],
                                                      signaling_data = sig_input,
                                                      metabolic_data = metab_input,
                                                      diff_expression_data = RNA_input,
                                                      maximum_network_depth = 5,
                                                      remove_unexpressed_nodes = T,
                                                      filter_tf_gene_interaction_by_optimization = T,
                                                      CARNIVAL_options = my_options)
```

For some reason, this first line (metab_input) removes all metab inputs
when using 786-0 cell line. For this reason, we use a different cell
line. (Anything else)


Different errors: Different solutions.

checkPerturbations error: Increase maximum_network_depth.


The above code chunk now works on my personal computer, but not on the
AMC computer, as I am getting the error (insert error here please future
Cathy \<3 ). For this reason, I will be using my personal computer until
further notice.

### Running signallling to metabolism

```{r}
my_options$timelimit <- 3600/10

test_result_for <- run_COSMOS_signaling_to_metabolism(data = test_for,
                                                      CARNIVAL_options = my_options)



formatted_res <- format_COSMOS_res(test_result_for)

SIF <- formatted_res[[1]]
ATT <- formatted_res[[2]]

SIF <- SIF[which(SIF$Weight != 0),]

RNA_input_df <- data.frame(Nodes = names(RNA_input), t = RNA_input)
ATT <- merge(ATT, RNA_input_df, all.x = T)
ATT <- ATT[ATT$AvgAct != 0,]


write_csv(SIF, file = paste("results/",paste(cell_line, "_SIF.csv",sep = ""), sep = ""))
write_csv(ATT, file = paste("results/",paste(cell_line, "_ATT.csv",sep = ""), sep = ""))
```

### Preprocessing metabolism to signalling

```{r}
my_options$timelimit <- 3600/10

test_back <- preprocess_COSMOS_metabolism_to_signaling(meta_network = meta_network,
                                                      signaling_data = sig_input,
                                                      metabolic_data = metab_input,
                                                      diff_expression_data = RNA_input,
                                                      maximum_network_depth = 5,
                                                      remove_unexpressed_nodes = T,
                                                      filter_tf_gene_interaction_by_optimization = T,
                                                      CARNIVAL_options = my_options)
```

### Running metabolism to signalling

```{r}
my_options$timelimit <- 3600/10

test_result_back <- run_COSMOS_metabolism_to_signaling(data = test_back,
                                                      CARNIVAL_options = my_options)

formatted_res_back <- format_COSMOS_res(test_result_back)

SIF_back <- formatted_res_back[[1]]
ATT_back <- formatted_res_back[[2]]

SIF_back <- SIF_back[which(SIF_back$Weight != 0),]

ATT_back <- merge(ATT_back, RNA_input_df, all.x = T)
ATT_back <- ATT_back[ATT_back$AvgAct != 0,]

```

### Saving metabolism to signalling

```{r}
write_csv(SIF_back, file = paste("results/",paste(cell_line, "_SIF_back.csv",sep = ""), sep = ""))
write_csv(ATT_back, file = paste("results/",paste(cell_line, "_ATT_back.csv",sep = ""), sep = ""))
```

### Combining datasets

```{r}
SIF_full <- as.data.frame(rbind(SIF,SIF_back))
SIF_full <- unique(SIF_full)

ATT_full <- as.data.frame(rbind(ATT,ATT_back))
ATT_full <- unique(ATT_full)

P_nodes <- ATT_full[ATT_full$NodeType == "P","Nodes"]
M_nodes <- ATT_full[ATT_full$NodeType == "M","Nodes"]
C_nodes <- union(P_nodes,M_nodes)
# C_nodes <- C_nodes[which(C_nodes %in% c(SIF$Node1,SIF$Node2) & C_nodes %in% c(SIF_back$Node1,SIF_back$Node2))]

ATT_full <- ATT_full[,-6]

ATT_full <- ATT_full %>% group_by(Nodes) %>% summarise_each(funs(mean(., na.rm = TRUE)))
ATT_full <- as.data.frame(ATT_full)

ATT_full$NodeType <- ifelse(ATT_full$Nodes %in% C_nodes,"C",ifelse(ATT_full$Nodes %in% P_nodes,"P",ifelse(ATT_full$Nodes %in% M_nodes,"M","")))

```

### Saving result

```{r}

write_csv(SIF_full, file = paste("results/",paste(cell_line, "_SIF_full.csv",sep = ""), sep = ""))
write_csv(ATT_full, file = paste("results/",paste(cell_line, "_ATT_full.csv",sep = ""), sep = ""))

```
